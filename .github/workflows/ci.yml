name: ðŸ§ª CI - Quality & Build Check
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: "18"
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  lint-and-format:
    name: ðŸ” Lint & Format Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸŽ¨ Check code formatting
        run: npm run format:check

      - name: ðŸ” Run ESLint
        run: npm run lint

      - name: ðŸ”§ Type check
        run: npm run check-types

  test-backend:
    name: ðŸ§ª Backend Tests
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: lint-and-format

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: portfolio_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—„ï¸ Run Prisma migrations
        run: |
          cd apps/api
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/portfolio_test

      - name: ðŸ§ª Run unit tests
        run: npm run test:unit --workspace=apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/portfolio_test

      - name: ðŸ”„ Run e2e tests
        run: npm run test:e2e --workspace=apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/portfolio_test

      - name: ðŸ“Š Generate coverage report
        run: npm run test:coverage --workspace=apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/portfolio_test

      - name: ðŸ“ˆ Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: apps/api/coverage/lcov.info
          flags: backend

  test-frontend:
    name: ðŸŒ Frontend Tests
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: lint-and-format

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ§ª Run unit tests
        run: npm run test:unit --workspace=apps/web

      - name: ðŸ“Š Generate coverage report
        run: npm run test:coverage --workspace=apps/web

      - name: ðŸ“ˆ Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: apps/web/coverage/lcov.info
          flags: frontend

  build-check:
    name: ðŸ”¨ Build Verification
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [lint-and-format, test-backend, test-frontend]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ”¨ Build applications
        run: npm run build

      - name: âœ… Verify build outputs
        run: |
          # Check backend build
          if [ ! -d "apps/api/dist" ]; then
            echo "âŒ Backend build failed - dist directory not found"
            exit 1
          fi

          # Check frontend build
          if [ ! -d "apps/web/.next" ]; then
            echo "âŒ Frontend build failed - .next directory not found"
            exit 1
          fi

          echo "âœ… All builds successful"

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ”’ Run security audit
        run: npm audit --audit-level moderate

      - name: ðŸ” Run dependency vulnerability check
        run: npx audit-ci --moderate

  docker-build:
    name: ðŸ³ Docker Build Test
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [lint-and-format, build-check, security-audit]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build API Docker image (test)
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: false
          load: true
          tags: portfolio-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ³ Build Web Docker image (test)
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          push: false
          load: true
          tags: portfolio-web:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ§ª Test Docker containers startup
        run: |
          echo "ðŸš€ Testing Docker container startup..."

          # Test API container
          echo "ðŸ“¡ Testing API container..."
          docker run --rm -d --name test-api \
            -e NODE_ENV=production \
            -e PORT=5000 \
            -e DATABASE_URL=postgresql://test:test@localhost:5432/test \
            -e JWT_SECRET=test_secret \
            -p 5000:5000 \
            portfolio-api:test

          # Wait for container to start
          sleep 10

          # Check if API container is running
          if ! docker ps | grep -q test-api; then
            echo "âŒ API container failed to start"
            echo "ðŸ“‹ API container logs:"
            docker logs test-api || echo "No logs available"
            exit 1
          fi

          echo "âœ… API container started successfully"
          docker stop test-api

          # Test Web container
          echo "ðŸŒ Testing Web container..."
          docker run --rm -d --name test-web \
            -e NODE_ENV=production \
            -e PORT=3000 \
            -p 3000:3000 \
            portfolio-web:test

          # Wait for container to start
          sleep 10

          # Check if Web container is running
          if ! docker ps | grep -q test-web; then
            echo "âŒ Web container failed to start"
            echo "ðŸ“‹ Web container logs:"
            docker logs test-web || echo "No logs available"
            exit 1
          fi

          echo "âœ… Web container started successfully"
          docker stop test-web

  ci-status:
    name: âœ… CI Status Check
    runs-on: ubuntu-latest
    if: always() && github.event.pull_request.draft == false
    needs:
      [
        lint-and-format,
        test-backend,
        test-frontend,
        build-check,
        security-audit,
        docker-build,
      ]
    outputs:
      ci-passed: ${{ steps.status.outputs.ci_passed }}

    steps:
      - name: âœ… Evaluate CI Status
        id: status
        run: |
          echo "## ðŸ§ª CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check individual job statuses
          LINT_STATUS="${{ needs.lint-and-format.result }}"
          BACKEND_TEST_STATUS="${{ needs.test-backend.result }}"
          FRONTEND_TEST_STATUS="${{ needs.test-frontend.result }}"
          BUILD_STATUS="${{ needs.build-check.result }}"
          SECURITY_STATUS="${{ needs.security-audit.result }}"
          DOCKER_STATUS="${{ needs.docker-build.result }}"

          echo "| Lint & Format | $([[ $LINT_STATUS == 'success' ]] && echo 'âœ…' || echo 'âŒ') $LINT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | $([[ $BACKEND_TEST_STATUS == 'success' ]] && echo 'âœ…' || echo 'âŒ') $BACKEND_TEST_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | $([[ $FRONTEND_TEST_STATUS == 'success' ]] && echo 'âœ…' || echo 'âŒ') $FRONTEND_TEST_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | $([[ $BUILD_STATUS == 'success' ]] && echo 'âœ…' || echo 'âŒ') $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | $([[ $SECURITY_STATUS == 'success' ]] && echo 'âœ…' || echo 'âŒ') $SECURITY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | $([[ $DOCKER_STATUS == 'success' ]] && echo 'âœ…' || echo 'âŒ') $DOCKER_STATUS |" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [[ "$LINT_STATUS" == "success" && "$BACKEND_TEST_STATUS" == "success" && "$FRONTEND_TEST_STATUS" == "success" && "$BUILD_STATUS" == "success" && "$SECURITY_STATUS" == "success" && "$DOCKER_STATUS" == "success" ]]; then
            echo "ci_passed=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **All CI checks passed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Code quality, tests, build, security, and Docker build verified." >> $GITHUB_STEP_SUMMARY
          else
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Some CI checks failed:**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Please fix the failing checks before proceeding." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
